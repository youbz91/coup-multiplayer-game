@page "/game"
@using Coup.Shared
@using Coup.Client.Blazor.Services
@inject GameService GameService
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Coup - Game</PageTitle>

<div class="game-container">
    @if (!_isInGame)
    {
        <div class="lobby-join">
            <h1>üé¥ Coup Game</h1>
            <div class="join-form">
                <input @bind="_playerName" placeholder="Your Name" class="input-field" />
                <input @bind="_gameId" placeholder="Game ID (default: room1)" class="input-field" />
                <button @onclick="JoinGame" class="btn btn-primary">Join Game</button>
            </div>
        </div>
    }
    else
    {
        <div class="game-board">
            <!-- Header -->
            <div class="game-header">
                <h2>Game: @GameService.CurrentGame.GameId</h2>
                <div class="game-status">
                    <span class="badge @(GameService.CurrentGame.GameStarted ? "badge-success" : "badge-warning")">
                        @(GameService.CurrentGame.GameStarted ? (GameService.CurrentGame.GameEnded ? "Ended" : "In Progress") : "Waiting")
                    </span>
                    @if (!string.IsNullOrEmpty(GameService.CurrentGame.WinnerName))
                    {
                        <span class="badge badge-gold">üèÜ Winner: @GameService.CurrentGame.WinnerName</span>
                    }
                </div>
            </div>

            <!-- Error Message -->
            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="alert alert-error">@_errorMessage</div>
            }

            <!-- Players -->
            <div class="players-section">
                <h3>Players</h3>
                <div class="players-grid">
                    @foreach (var (player, index) in GameService.CurrentGame.Players.Select((p, i) => (p, i)))
                    {
                        var isCurrentPlayer = index == GameService.CurrentGame.CurrentPlayerIndex;
                        var isMe = player.Name == GameService.MyName;
                        <div class="player-card @(isMe ? "player-me" : "") @(isCurrentPlayer ? "player-current" : "") @(player.IsAlive ? "" : "player-dead")">
                            <div class="player-name">
                                @if (isCurrentPlayer) { <span class="turn-indicator">‚ñ∂</span> }
                                [@index] @player.Name
                                @if (player.ConnectionId == GameService.CurrentGame.HostConnectionId) { <span class="host-badge">üëë</span> }
                            </div>
                            <div class="player-stats">
                                <span class="coins">üí∞ @player.Coins</span>
                                <span class="influence">‚ù§Ô∏è @player.InfluenceCount</span>
                            </div>
                            @if (!player.IsAlive)
                            {
                                <span class="dead-mark">‚ò†Ô∏è</span>
                            }
                        </div>
                    }
                </div>
            </div>

            <!-- My Info -->
            @if (GameService.GetMe() != null)
            {
                <div class="my-info">
                    <h3>Your Hand</h3>
                    <div class="my-roles">
                        @if (GameService.MyRoles.Any())
                        {
                            @foreach (var role in GameService.MyRoles)
                            {
                                <div class="role-card">@GetRoleIcon(role) @role</div>
                            }
                        }
                        else
                        {
                            <div class="no-roles">No roles yet</div>
                        }
                    </div>
                    <div class="my-stats">
                        <span>üí∞ Coins: @GameService.GetMe()!.Coins</span>
                        <span>‚ù§Ô∏è Influence: @GameService.GetMe()!.InfluenceCount</span>
                    </div>
                </div>
            }

            <!-- Pending Action -->
            @if (GameService.CurrentGame.Pending != null)
            {
                var pending = GameService.CurrentGame.Pending;
                var me = GameService.GetMe();

                <div class="pending-action">
                    <!-- Timer for any pending action -->
                    @if (GameService.CurrentGame.PendingStartTime.HasValue)
                    {
                        var elapsed = (DateTime.UtcNow - GameService.CurrentGame.PendingStartTime.Value).TotalSeconds;
                        var remaining = Math.Max(0, 30 - elapsed);
                        var percentage = (remaining / 30.0) * 100;
                        var timerClass = remaining < 10 ? "timer-warning" : "";

                        <div class="pending-timer @timerClass">
                            <div class="timer-bar">
                                <div class="timer-fill" style="width: @percentage%"></div>
                            </div>
                            <div class="timer-text">‚è±Ô∏è @((int)remaining)s remaining</div>
                        </div>
                    }

                    @if (pending.Phase == PendingPhase.ActionClaim)
                    {
                        <!-- PHASE 1: Someone is performing an action -->
                        var actor = GameService.CurrentGame.Players.FirstOrDefault(p => p.ConnectionId == pending.ActorConnectionId);
                        var isMyAction = me != null && pending.ActorConnectionId == me.ConnectionId;

                        <h4>‚è≥ Pending Action</h4>
                        <p><strong>@actor?.Name</strong> claims <strong>@pending.ClaimedRole</strong> to perform <strong>@pending.Action</strong></p>

                        @if (!isMyAction)
                        {
                            <div class="action-buttons">
                                <!-- Always show Challenge and Pass -->
                                <button @onclick="Challenge" class="btn btn-danger">‚öîÔ∏è Challenge</button>
                                <button @onclick="Pass" class="btn btn-secondary">üëç Pass</button>

                                <!-- Show block buttons based on action type (only in ActionClaim phase) -->
                                @if (pending.Action == ActionType.ForeignAid)
                                {
                                    <button @onclick="BlockDuke" class="btn btn-block-duke">üèõÔ∏è Block (Duke)</button>
                                }
                                @if (pending.Action == ActionType.Assassinate)
                                {
                                    <button @onclick="BlockContessa" class="btn btn-block-contessa">üë∏ Block (Contessa)</button>
                                }
                                @if (pending.Action == ActionType.Steal)
                                {
                                    <button @onclick="BlockCaptain" class="btn btn-block-captain">‚öì Block (Captain)</button>
                                    <button @onclick="BlockAmbassador" class="btn btn-block-ambassador">üåç Block (Ambassador)</button>
                                }
                            </div>

                            @if (pending.Responded != null)
                            {
                                var otherPlayers = GameService.CurrentGame.Players.Where(p => p.IsAlive && p.ConnectionId != pending.ActorConnectionId).ToList();
                                var waiting = otherPlayers.Where(p => !pending.Responded.Contains(p.ConnectionId)).Select(p => p.Name).ToList();

                                @if (waiting.Any())
                                {
                                    <p class="waiting-text"><em>Waiting for: @string.Join(", ", waiting)</em></p>
                                }
                                else
                                {
                                    <p class="waiting-text"><em>All players responded. Action will auto-resolve...</em></p>
                                }
                            }
                        }
                        else
                        {
                            <p class="waiting-text"><em>Waiting for other players to respond...</em></p>
                        }
                    }
                    else if (pending.Phase == PendingPhase.BlockClaim)
                    {
                        <!-- PHASE 2: Someone is blocking an action (THIS WAS MISSING!) -->
                        var blocker = GameService.CurrentGame.Players.FirstOrDefault(p => p.ConnectionId == pending.BlockerConnectionId);
                        var actor = GameService.CurrentGame.Players.FirstOrDefault(p => p.ConnectionId == pending.ActorConnectionId);
                        var isMyBlock = me != null && pending.BlockerConnectionId == me.ConnectionId;

                        <h4>üõ°Ô∏è Block Claim</h4>
                        <p><strong>@blocker?.Name</strong> claims <strong>@pending.BlockClaimedRole</strong> to block <strong>@actor?.Name</strong>'s <strong>@pending.Action</strong></p>

                        @if (!isMyBlock)
                        {
                            <div class="action-buttons">
                                <!-- Others can challenge the block claim or pass -->
                                <button @onclick="Challenge" class="btn btn-danger">‚öîÔ∏è Challenge Block</button>
                                <button @onclick="Pass" class="btn btn-secondary">üëç Pass</button>
                            </div>

                            @if (pending.BlockResponded != null)
                            {
                                var otherPlayers = GameService.CurrentGame.Players.Where(p => p.IsAlive && p.ConnectionId != pending.BlockerConnectionId).ToList();
                                var waiting = otherPlayers.Where(p => !pending.BlockResponded.Contains(p.ConnectionId)).Select(p => p.Name).ToList();

                                @if (waiting.Any())
                                {
                                    <p class="waiting-text"><em>Waiting for: @string.Join(", ", waiting)</em></p>
                                }
                                else
                                {
                                    <p class="waiting-text"><em>All players responded. Block will auto-resolve...</em></p>
                                }
                            }
                        }
                        else
                        {
                            <p class="waiting-text"><em>Waiting for other players to respond to your block...</em></p>
                        }
                    }
                </div>
            }

            <!-- Choose Card to Lose -->
            @if (GameService.MustChooseCard)
            {
                <div class="choose-card">
                    <h4>‚ö†Ô∏è Choose a Card to Lose</h4>
                    <p>@GameService.ChooseCardReason</p>
                    <div class="role-buttons">
                        @foreach (var role in GameService.MyRoles)
                        {
                            <button @onclick="() => ChooseCard(role)" class="btn btn-role">
                                @GetRoleIcon(role) @role
                            </button>
                        }
                    </div>
                </div>
            }

            <!-- Exchange Card Selection -->
            @if (GameService.MustChooseExchangeCards)
            {
                <div class="exchange-selection">
                    <h4>üîÑ Choose Cards to Keep</h4>
                    <p>Select @GameService.ExchangeCardsToKeep card(s) to keep. The rest will be returned to the deck.</p>
                    <div class="exchange-cards">
                        @foreach (var (card, index) in GameService.ExchangeAvailableCards.Select((c, i) => (c, i)))
                        {
                            var isSelected = _selectedExchangeCards.Contains(card);
                            var buttonClass = isSelected ? "btn-exchange-card selected" : "btn-exchange-card";
                            <button @onclick="() => ToggleExchangeCard(card)" class="@buttonClass">
                                <div class="card-icon">@GetRoleIcon(card)</div>
                                <div class="card-name">@card</div>
                                @if (isSelected)
                                {
                                    <div class="selected-badge">‚úì</div>
                                }
                            </button>
                        }
                    </div>
                    <div class="exchange-actions">
                        <p>Selected: @_selectedExchangeCards.Count / @GameService.ExchangeCardsToKeep</p>
                        <button @onclick="SubmitExchangeCards"
                                class="btn btn-primary"
                                disabled="@(_selectedExchangeCards.Count != GameService.ExchangeCardsToKeep)">
                            Confirm Selection
                        </button>
                    </div>
                </div>
            }

            <!-- Actions -->
            @if (GameService.IsMyTurn() && !GameService.MustChooseCard)
            {
                <div class="actions-section">
                    <h3>Your Turn - Choose Action</h3>
                    <div class="actions-grid">
                        <button @onclick="() => PerformAction(ActionType.Income, null)" class="btn btn-action">
                            üíµ Income (+1)
                        </button>
                        <button @onclick="() => PerformAction(ActionType.ForeignAid, null)" class="btn btn-action">
                            üåç Foreign Aid (+2)
                        </button>
                        <button @onclick="() => PerformAction(ActionType.Tax, null)" class="btn btn-action">
                            üèõÔ∏è Tax (Duke, +3)
                        </button>
                        <button @onclick="() => PerformAction(ActionType.Exchange, null)" class="btn btn-action">
                            üîÑ Exchange (Ambassador)
                        </button>
                    </div>
                    <div class="targeted-actions">
                        <h4>Target Player:</h4>
                        @foreach (var (player, index) in GameService.CurrentGame.Players.Select((p, i) => (p, i)))
                        {
                            if (player.Name != GameService.MyName && player.IsAlive)
                            {
                                <div class="target-actions">
                                    <span class="target-name">[@index] @player.Name</span>
                                    <button @onclick="() => ShowConfirmation(ActionType.Coup, player.ConnectionId, player.Name)" class="btn btn-sm btn-coup" disabled="@(GameService.GetMe()!.Coins < 7)">
                                        ‚öîÔ∏è Coup (7 coins)
                                    </button>
                                    <button @onclick="() => ShowConfirmation(ActionType.Assassinate, player.ConnectionId, player.Name)" class="btn btn-sm btn-assassinate" disabled="@(GameService.GetMe()!.Coins < 3)">
                                        üó°Ô∏è Assassinate (3 coins)
                                    </button>
                                    <button @onclick="() => PerformAction(ActionType.Steal, player.ConnectionId)" class="btn btn-sm btn-steal">
                                        üí∞ Steal (Captain)
                                    </button>
                                </div>
                            }
                        }
                    </div>
                </div>
            }

            <!-- Game Controls -->
            <div class="game-controls">
                @if (!GameService.CurrentGame.GameStarted && GameService.IsHost())
                {
                    <button @onclick="StartGame" class="btn btn-success btn-lg">‚ñ∂Ô∏è Start Game</button>
                }
                @if (GameService.CurrentGame.GameEnded && GameService.IsHost())
                {
                    <button @onclick="Rematch" class="btn btn-primary btn-lg">üîÑ Rematch</button>
                }
            </div>

            <!-- Game Log -->
            <div class="game-log">
                <h3>Game Log</h3>
                <div class="log-entries">
                    @foreach (var entry in GameService.CurrentGame.Log.TakeLast(15))
                    {
                        <div class="log-entry">‚Ä¢ @entry</div>
                    }
                </div>
            </div>
        </div>
    }

    <!-- Confirmation Modal -->
    @if (_showConfirmation)
    {
        <div class="modal-overlay" @onclick="CancelConfirmation">
            <div class="modal-content" @onclick:stopPropagation="true">
                <h3>‚ö†Ô∏è Confirm Action</h3>
                <p>
                    @if (_pendingAction == ActionType.Coup)
                    {
                        <strong>Are you sure you want to Coup @_pendingTargetName?</strong><br />
                        <span class="confirmation-details">This will cost 7 coins and cannot be challenged or blocked.</span>
                    }
                    else if (_pendingAction == ActionType.Assassinate)
                    {
                        <strong>Are you sure you want to Assassinate @_pendingTargetName?</strong><br />
                        <span class="confirmation-details">This will cost 3 coins. It can be blocked by Contessa.</span>
                    }
                </p>
                <div class="modal-actions">
                    <button @onclick="ConfirmAction" class="btn btn-danger">‚úì Confirm</button>
                    <button @onclick="CancelConfirmation" class="btn btn-secondary">‚úó Cancel</button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool _isInGame = false;
    private string _playerName = "";
    private string _gameId = "room1";
    private string _errorMessage = "";
    private List<Role> _selectedExchangeCards = new();
    private System.Threading.Timer? _uiTimer;

    // Confirmation dialog state
    private bool _showConfirmation = false;
    private ActionType _pendingAction;
    private string _pendingTargetId = "";
    private string _pendingTargetName = "";

    protected override async Task OnInitializedAsync()
    {
        GameService.OnGameStateChanged += StateHasChanged;
        GameService.OnRolesReceived += StateHasChanged;
        GameService.OnError += ShowError;
        GameService.OnChooseInfluence += OnChooseInfluence;
        GameService.OnChooseExchangeCards += OnChooseExchangeCards;

        await GameService.ConnectAsync();

        // Start UI refresh timer for countdown updates
        _uiTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(StateHasChanged);
        }, null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(1));
    }

    private async Task JoinGame()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(_playerName))
                _playerName = $"Player_{Random.Shared.Next(1000, 9999)}";

            if (string.IsNullOrWhiteSpace(_gameId))
                _gameId = "room1";

            await GameService.JoinLobbyAsync(_gameId, _playerName);
            _isInGame = true;
            _errorMessage = "";
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error joining game: {ex.Message}";
        }
    }

    private async Task StartGame()
    {
        try
        {
            await GameService.StartGameAsync(GameService.CurrentGame.GameId);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error starting game: {ex.Message}";
        }
    }

    private async Task Rematch()
    {
        try
        {
            await GameService.RematchAsync(GameService.CurrentGame.GameId);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error starting rematch: {ex.Message}";
        }
    }

    private async Task PerformAction(ActionType action, string? targetConnectionId)
    {
        try
        {
            await GameService.PerformActionAsync(new ActionDto
            {
                Action = action,
                TargetConnectionId = targetConnectionId
            });
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error performing action: {ex.Message}";
        }
    }

    private async Task Challenge()
    {
        await GameService.ChallengeAsync();
    }

    private async Task Pass()
    {
        await GameService.PassPendingAsync();
    }

    private async Task BlockDuke()
    {
        await GameService.BlockDukeAsync();
    }

    private async Task BlockContessa()
    {
        await GameService.BlockContessaAsync();
    }

    private async Task BlockCaptain()
    {
        await GameService.BlockWithRoleAsync(Role.Captain);
    }

    private async Task BlockAmbassador()
    {
        await GameService.BlockWithRoleAsync(Role.Ambassador);
    }

    private async Task ChooseCard(Role role)
    {
        await GameService.ChooseCardToLoseAsync(role);
        StateHasChanged();
    }

    private void ShowError(string message)
    {
        _errorMessage = message;
        StateHasChanged();
    }

    private void OnChooseInfluence(string message)
    {
        StateHasChanged();
    }

    private void OnChooseExchangeCards()
    {
        _selectedExchangeCards.Clear();
        StateHasChanged();
    }

    private void ToggleExchangeCard(Role card)
    {
        if (_selectedExchangeCards.Contains(card))
        {
            _selectedExchangeCards.Remove(card);
        }
        else
        {
            if (_selectedExchangeCards.Count < GameService.ExchangeCardsToKeep)
            {
                _selectedExchangeCards.Add(card);
            }
        }
        StateHasChanged();
    }

    private async Task SubmitExchangeCards()
    {
        if (_selectedExchangeCards.Count == GameService.ExchangeCardsToKeep)
        {
            try
            {
                await GameService.SubmitExchangeCardsAsync(new List<Role>(_selectedExchangeCards));
                _selectedExchangeCards.Clear();
                _errorMessage = "";
            }
            catch (Exception ex)
            {
                _errorMessage = $"Error submitting cards: {ex.Message}";
            }
        }
    }

    private void ShowConfirmation(ActionType action, string targetId, string targetName)
    {
        _pendingAction = action;
        _pendingTargetId = targetId;
        _pendingTargetName = targetName;
        _showConfirmation = true;
    }

    private async Task ConfirmAction()
    {
        _showConfirmation = false;
        await PerformAction(_pendingAction, _pendingTargetId);
        _pendingTargetId = "";
        _pendingTargetName = "";
    }

    private void CancelConfirmation()
    {
        _showConfirmation = false;
        _pendingTargetId = "";
        _pendingTargetName = "";
    }

    private string GetRoleIcon(Role role)
    {
        return role switch
        {
            Role.Duke => "üèõÔ∏è",
            Role.Assassin => "üó°Ô∏è",
            Role.Captain => "‚öì",
            Role.Ambassador => "üåç",
            Role.Contessa => "üë∏",
            _ => "‚ùì"
        };
    }

    public void Dispose()
    {
        GameService.OnGameStateChanged -= StateHasChanged;
        GameService.OnRolesReceived -= StateHasChanged;
        GameService.OnError -= ShowError;
        GameService.OnChooseInfluence -= OnChooseInfluence;
        GameService.OnChooseExchangeCards -= OnChooseExchangeCards;
        _uiTimer?.Dispose();
    }
}
